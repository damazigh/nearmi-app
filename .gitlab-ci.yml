stages:
  - build
docker-img:
  stage: build
  script:
    - |
      ENV=${TARGET_ENV};
      if [[ -z ${ENV} ]];
      then
        ENV="dev";
      fi
      TARGET_ENV=${ENV};
      TAG=$(sed 's/.*"version": "\(.*\)".*/\1/;t;d' ./package.json);
      echo "building image nearmi-${ENV}/app:${TAG}";
      docker build -f ./Dockerfile -t nearmi-${ENV}/app:${TAG} .;
      docker tag nearmi-${ENV}/app:${TAG} nearmi.io/nearmi-${ENV}/app:${TAG};
      echo "push built image"
      docker push nearmi.io/nearmi-${ENV}/app:${TAG};
      echo "Cleaning dangling images";
      docker image rmi -f $(docker images -f "dangling=true" -q);
      echo "Au revoir !";
  tags:
    - shell
